<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Security Monitor Test</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .message {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .suspicious { border-left-color: #ffc107; background-color: #fff3cd; }
        .high-risk { border-left-color: #fd7e14; background-color: #ffeaa7; }
        .critical { border-left-color: #dc3545; background-color: #f8d7da; }
        .suspended { border-left-color: #6f42c1; background-color: #e2d9f3; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí WebSocket Security Monitor Test</h1>
        
        <div class="test-section">
            <h3>Connection Status</h3>
            <div id="status" class="status disconnected">Connecting...</div>
            <button onclick="testConnection()">Test Connection</button>
            <button onclick="testAuth()">Test Authentication</button>
            <button onclick="clearMessages()">Clear Messages</button>
        </div>

        <div class="test-section">
            <h3>CORS Test</h3>
            <button onclick="testCORS()">Test CORS Request</button>
            <div id="corsResult"></div>
        </div>

        <div class="test-section">
            <h3>Security Events (Real-time)</h3>
            <div id="messages"></div>
        </div>

        <div class="test-section">
            <h3>Simulate Security Events</h3>
            <button onclick="simulateEvent('suspicious')">Simulate Suspicious Activity</button>
            <button onclick="simulateEvent('high_risk')">Simulate High Risk</button>
            <button onclick="simulateEvent('critical')">Simulate Critical Threat</button>
            <button onclick="simulateEvent('suspend')">Simulate Suspension</button>
        </div>
    </div>

    <script>
        let socket = null;
        const status = document.getElementById('status');
        const messages = document.getElementById('messages');
        const corsResult = document.getElementById('corsResult');

        function connect() {
            if (socket) {
                socket.disconnect();
            }

            socket = io('http://localhost:3000', {
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                updateStatus('Connected ‚úÖ', 'connected');
                addMessage('üîå WebSocket connected successfully!', 'message');
            });

            socket.on('disconnect', (reason) => {
                updateStatus('Disconnected ‚ùå', 'disconnected');
                addMessage(`üîå WebSocket disconnected: ${reason}`, 'message');
            });

            socket.on('authenticated', (data) => {
                addMessage(`‚úÖ Authenticated: ${JSON.stringify(data)}`, 'message');
            });

            socket.on('auth-error', (error) => {
                addMessage(`‚ùå Auth Error: ${JSON.stringify(error)}`, 'critical');
            });

            // Security event listeners
            socket.on('suspicious_activity', (data) => {
                addMessage(`üö® Suspicious Activity: User ${data.data.userId}, Risk: ${data.data.riskLevel?.score}%`, 'suspicious');
            });

            socket.on('high_risk_session', (data) => {
                addMessage(`‚ö†Ô∏è High Risk Session: User ${data.data.userId}, Risk: ${data.data.riskLevel?.score}%`, 'high-risk');
            });

            socket.on('critical_threat', (data) => {
                addMessage(`üö® Critical Threat: User ${data.data.userId}, Risk: ${data.data.riskLevel?.score}%`, 'critical');
            });

            socket.on('session_suspended', (data) => {
                addMessage(`‚õî Session Suspended: User ${data.data.userId}, Reason: ${data.data.suspensionReason}`, 'suspended');
            });

            socket.on('monitoring_increased', (data) => {
                addMessage(`üîç Monitoring Increased: ${data.data.message}`, 'high-risk');
            });

            socket.on('security_warning', (data) => {
                addMessage(`‚ö†Ô∏è Security Warning: ${data.data.message}`, 'high-risk');
            });

            socket.on('session_ended', (data) => {
                addMessage(`üõë Session Ended: Reason - ${data.data.reason}`, 'critical');
            });

            socket.on('pong', () => {
                addMessage('üèì Pong received - Connection is alive!', 'message');
            });
        }

        function updateStatus(text, className) {
            status.textContent = text;
            status.className = `status ${className}`;
        }

        function addMessage(text, className = 'message') {
            const messageDiv = document.createElement('div');
            messageDiv.className = className;
            messageDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${text}`;
            messages.insertBefore(messageDiv, messages.firstChild);
        }

        function testConnection() {
            connect();
        }

        function testAuth() {
            if (!socket || !socket.connected) {
                addMessage('‚ùå Socket not connected. Connect first!', 'critical');
                return;
            }

            socket.emit('authenticate', {
                userId: 'test-admin-' + Date.now(),
                examId: 'test-exam-123',
                isAdmin: true,
                token: 'test-token-' + Date.now()
            });

            // Test ping
            setTimeout(() => {
                socket.emit('ping');
            }, 1000);
        }

        async function testCORS() {
            try {
                corsResult.innerHTML = 'Testing CORS...';
                
                const response = await fetch('http://localhost:3000/live', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    corsResult.innerHTML = `‚úÖ CORS Test Passed: ${JSON.stringify(data)}`;
                    corsResult.style.color = 'green';
                } else {
                    corsResult.innerHTML = `‚ùå CORS Test Failed: ${response.status}`;
                    corsResult.style.color = 'red';
                }
            } catch (error) {
                corsResult.innerHTML = `‚ùå CORS Test Error: ${error.message}`;
                corsResult.style.color = 'red';
            }
        }

        function simulateEvent(type) {
            if (!socket || !socket.connected) {
                addMessage('‚ùå Socket not connected. Connect first!', 'critical');
                return;
            }

            const testData = {
                timestamp: new Date().toISOString(),
                type: type,
                data: {
                    userId: 'test-user-123',
                    examId: 'test-exam-456',
                    violation: {
                        type: 'SIMULATED_VIOLATION',
                        details: { simulated: true }
                    },
                    riskLevel: {
                        score: Math.floor(Math.random() * 40) + 60, // 60-100
                        level: type.toUpperCase()
                    }
                }
            };

            // Emit the test event based on type
            switch (type) {
                case 'suspicious':
                    socket.emit('test_event', { ...testData, eventType: 'suspicious_activity' });
                    break;
                case 'high_risk':
                    socket.emit('test_event', { ...testData, eventType: 'high_risk_session' });
                    break;
                case 'critical':
                    socket.emit('test_event', { ...testData, eventType: 'critical_threat' });
                    break;
                case 'suspend':
                    socket.emit('test_event', { ...testData, eventType: 'session_suspended' });
                    break;
            }

            addMessage(`üì§ Simulated ${type} event sent`, 'message');
        }

        function clearMessages() {
            messages.innerHTML = '';
        }

        // Auto-connect on page load
        window.onload = function() {
            addMessage('üåê Page loaded. Click "Test Connection" to start.', 'message');
        };
    </script>
</body>
</html>
