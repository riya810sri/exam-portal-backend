name: CI/CD Pipeline

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:
    inputs:
      image_name:
        description: "Docker image name"
        required: true
        default: "harisons_backend"
      container_name:
        description: "Docker container name"
        required: true
        default: "harisons_backend"
      container_port:
        description: "Container port to expose"
        required: true
        default: "6000"
      host_port:
        description: "Host port to map to container"
        required: true
        default: "6000"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ${{ github.event.inputs.image_name || secrets.IMAGE_NAME }}
      CONTAINER_NAME: ${{ github.event.inputs.container_name || 'harisons_backend' }}
      CONTAINER_PORT: ${{ github.event.inputs.container_port || secrets.CONTAINER_PORT }}
      HOST_PORT: ${{ github.event.inputs.host_port || secrets.HOST_PORT }}
      APP_NAME: ${{ secrets.APP_NAME }}
      START_FILE: ${{ secrets.START_FILE_PATH }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEV_SFTP_PRIVATE_KEY }}

      - name: Ensure `tar` Installed
        run: |
          sudo apt-get update && sudo apt-get install -y tar

      - name: Archive Project (Excluding Unwanted Files)
        run: |
          tar --exclude='.git' --exclude='.github' --exclude='node_modules' --ignore-failed-read --warning=no-file-changed -czf project.tar.gz .

      - name: Transfer Archive to Server
        run: |
          scp -o StrictHostKeyChecking=no project.tar.gz ${{ secrets.DEV_USER }}@${{ secrets.DEV_HOST }}:${{ secrets.DEPLOY_DIR }}

      - name: Trigger Remote Deployment via SSH
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.DEV_USER }}@${{ secrets.DEV_HOST }} "set -e && \
            cd ${{ secrets.DEPLOY_DIR }} && \
            echo 'ðŸ“¦ Extracting project...' && \
            tar -xzf project.tar.gz && \
            rm project.tar.gz && \
            
            echo 'ðŸ” Creating env file if missing...' && \
            [ -f \"${{ secrets.ENV_FILE }}\" ] || echo \"${{ secrets.ENV }}\" > \"${{ secrets.ENV_FILE }}\" && \
            
            echo 'ðŸ“¦ Installing dependencies...' && \
            npm install && \
            
            echo 'ðŸ”§ Fixing vulnerabilities...' && \
            npm audit fix --force || true && \
            
            echo 'ðŸš€ Deploying via PM2...' && \
            APP_NAME=\"${{ secrets.APP_NAME }}\" && \
            START_FILE=\"${{ secrets.START_FILE_PATH }}\" && \
            
            if ! pm2 show \"\$APP_NAME\" > /dev/null 2>&1; then \
              echo 'Starting new instance...' && \
              pm2 start \"\$START_FILE\" --name \"\$APP_NAME\"; \
            else \
              echo 'Restarting existing app...' && \
              pm2 restart \"\$APP_NAME\"; \
            fi"
