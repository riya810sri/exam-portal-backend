<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Security Monitor Test</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .pending { background-color: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        .alert-info {
            background-color: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .alert-danger {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê WebSocket Security Monitor Test</h1>
        <p>Test the real-time security monitoring WebSocket implementation</p>
        
        <div id="connectionStatus" class="status pending">
            üîå Not Connected
        </div>
    </div>

    <div class="grid">
        <!-- Student Panel -->
        <div class="container">
            <h2>üë®‚Äçüéì Student Panel</h2>
            <div>
                <label>User ID: </label>
                <input type="text" id="studentUserId" value="student123" style="padding: 5px; margin: 5px;">
            </div>
            <div>
                <label>Exam ID: </label>
                <input type="text" id="examId" value="exam456" style="padding: 5px; margin: 5px;">
            </div>
            <button onclick="connectAsStudent()">Connect as Student</button>
            <button onclick="simulateSecurityViolation()">Simulate Security Violation</button>
            <button onclick="simulateHighRisk()">Simulate High Risk</button>
            
            <div id="studentAlerts"></div>
        </div>

        <!-- Admin Panel -->
        <div class="container">
            <h2>üë®‚Äçüíº Admin Panel</h2>
            <div>
                <label>Admin ID: </label>
                <input type="text" id="adminUserId" value="admin789" style="padding: 5px; margin: 5px;">
            </div>
            <button onclick="connectAsAdmin()">Connect as Admin</button>
            <button onclick="simulateCriticalThreat()">Simulate Critical Threat</button>
            <button onclick="simulateAutoSuspend()">Simulate Auto Suspend</button>
            
            <div id="adminAlerts"></div>
        </div>
    </div>

    <div class="container">
        <h3>üìã WebSocket Event Log</h3>
        <button onclick="clearLog()">Clear Log</button>
        <div id="eventLog" class="log">
            <p><em>Events will appear here...</em></p>
        </div>
    </div>

    <script>
        let socket = null;
        let isStudent = false;
        let isAdmin = false;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('eventLog');
            const entry = document.createElement('div');
            entry.style.marginBottom = '5px';
            entry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#333';
            entry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = `status ${status}`;
            statusElement.textContent = message;
        }

        function connectAsStudent() {
            if (socket) socket.disconnect();
            
            const userId = document.getElementById('studentUserId').value;
            const examId = document.getElementById('examId').value;
            
            socket = io('http://localhost:3000');
            isStudent = true;
            isAdmin = false;
            
            socket.on('connect', () => {
                updateConnectionStatus('connected', 'üîå Connected as Student');
                log(`Connected as student (ID: ${userId}, Exam: ${examId})`, 'success');
                
                // Authenticate as student
                socket.emit('authenticate', {
                    userId: userId,
                    examId: examId,
                    isAdmin: false,
                    token: 'fake-token'
                });
            });

            socket.on('authenticated', (data) => {
                log(`Authentication successful: ${JSON.stringify(data)}`, 'success');
            });

            socket.on('disconnect', () => {
                updateConnectionStatus('disconnected', 'üîå Disconnected');
                log('Disconnected from WebSocket', 'error');
            });

            // Listen for security alerts
            socket.on('security-alert', (data) => {
                log(`üö® Security Alert: ${JSON.stringify(data)}`, 'error');
                showStudentAlert('Security Alert', data.data?.message || 'Security violation detected', 'warning');
            });

            socket.on('security-warning', (data) => {
                log(`‚ö†Ô∏è Security Warning: ${JSON.stringify(data)}`, 'error');
                showStudentAlert('Security Warning', data.data?.message || 'Please review your actions', 'warning');
            });

            socket.on('session-suspended', (data) => {
                log(`‚ùå Session Suspended: ${JSON.stringify(data)}`, 'error');
                showStudentAlert('Session Suspended', data.data?.message || 'Your session has been suspended', 'danger');
            });

            socket.on('pong', () => {
                log('Pong received', 'success');
            });
        }

        function connectAsAdmin() {
            if (socket) socket.disconnect();
            
            const userId = document.getElementById('adminUserId').value;
            
            socket = io('http://localhost:3000');
            isStudent = false;
            isAdmin = true;
            
            socket.on('connect', () => {
                updateConnectionStatus('connected', 'üîå Connected as Admin');
                log(`Connected as admin (ID: ${userId})`, 'success');
                
                // Authenticate as admin
                socket.emit('authenticate', {
                    userId: userId,
                    isAdmin: true,
                    token: 'fake-admin-token'
                });
            });

            socket.on('authenticated', (data) => {
                log(`Authentication successful: ${JSON.stringify(data)}`, 'success');
            });

            socket.on('disconnect', () => {
                updateConnectionStatus('disconnected', 'üîå Disconnected');
                log('Disconnected from WebSocket', 'error');
            });

            // Listen for admin notifications
            socket.on('high-risk-detected', (data) => {
                log(`üî¥ High Risk Detection: ${JSON.stringify(data)}`, 'error');
                showAdminAlert('High Risk Detection', `User ${data.data?.userId} flagged as high risk`, 'warning');
            });

            socket.on('critical-threat-detected', (data) => {
                log(`üíÄ Critical Threat: ${JSON.stringify(data)}`, 'error');
                showAdminAlert('Critical Threat', `URGENT: ${data.data?.message}`, 'danger');
            });

            socket.on('auto-suspend-triggered', (data) => {
                log(`üõë Auto Suspend: ${JSON.stringify(data)}`, 'error');
                showAdminAlert('Auto Suspend', `Session automatically suspended: ${data.data?.reason}`, 'danger');
            });

            socket.on('security-stats-update', (data) => {
                log(`üìä Security Stats: ${JSON.stringify(data)}`, 'info');
                showAdminAlert('Security Update', 'Security statistics updated', 'info');
            });
        }

        function showStudentAlert(title, message, type) {
            const alertsElement = document.getElementById('studentAlerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `<strong>${title}:</strong> ${message}`;
            alertsElement.appendChild(alert);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 10000);
        }

        function showAdminAlert(title, message, type) {
            const alertsElement = document.getElementById('adminAlerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `<strong>${title}:</strong> ${message}`;
            alertsElement.appendChild(alert);
            
            // Auto-remove after 15 seconds for admin alerts
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 15000);
        }

        // Simulation functions
        function simulateSecurityViolation() {
            if (!socket || !isStudent) {
                alert('Please connect as student first');
                return;
            }
            
            // Simulate receiving a security alert
            socket.emit('ping'); // Test connection
            
            // Manually trigger security alert for testing
            setTimeout(() => {
                const fakeAlert = {
                    timestamp: new Date().toISOString(),
                    type: 'security-alert',
                    data: {
                        message: 'Tab switching detected',
                        severity: 'medium',
                        userId: document.getElementById('studentUserId').value
                    }
                };
                socket.emit('security-alert', fakeAlert);
                log('Simulated security violation', 'info');
            }, 500);
        }

        function simulateHighRisk() {
            if (!socket || !isStudent) {
                alert('Please connect as student first');
                return;
            }
            
            const fakeAlert = {
                timestamp: new Date().toISOString(),
                type: 'security-warning',
                data: {
                    message: 'Multiple violations detected - high risk session',
                    severity: 'high',
                    userId: document.getElementById('studentUserId').value
                }
            };
            socket.emit('security-warning', fakeAlert);
            log('Simulated high risk scenario', 'info');
        }

        function simulateCriticalThreat() {
            if (!socket || !isAdmin) {
                alert('Please connect as admin first');
                return;
            }
            
            const fakeAlert = {
                timestamp: new Date().toISOString(),
                type: 'critical-threat-detected',
                data: {
                    message: 'Potential cheating detected - immediate action required',
                    severity: 'critical',
                    userId: 'student123',
                    examId: 'exam456'
                }
            };
            socket.emit('critical-threat-detected', fakeAlert);
            log('Simulated critical threat for admin', 'info');
        }

        function simulateAutoSuspend() {
            if (!socket || !isAdmin) {
                alert('Please connect as admin first');
                return;
            }
            
            const fakeAlert = {
                timestamp: new Date().toISOString(),
                type: 'auto-suspend-triggered',
                data: {
                    message: 'Session automatically suspended due to repeated violations',
                    reason: 'Multiple tab switches and suspicious mouse patterns',
                    userId: 'student123',
                    examId: 'exam456'
                }
            };
            socket.emit('auto-suspend-triggered', fakeAlert);
            log('Simulated auto-suspend for admin', 'info');
        }

        function clearLog() {
            document.getElementById('eventLog').innerHTML = '<p><em>Events will appear here...</em></p>';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            log('WebSocket Security Monitor Test Page Loaded', 'success');
            log('Instructions: Connect as Student or Admin, then simulate security events', 'info');
        });
    </script>
</body>
</html>
